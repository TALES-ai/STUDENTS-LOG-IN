<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Student Portal - Borabu TTC</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: 'Poppins', sans-serif;
      background: #f4f7fa;
      min-height: 100vh;
      color: #333;
      display: flex;
      flex-direction: column;
    }
    .container {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    .header {
      background: linear-gradient(135deg, #ffd700, #ffca28);
      color: #004d40;
      padding: 12px 16px;
      text-align: center;
      font-size: 20px;
      font-weight: 600;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      position: fixed;
      top: 0;
      width: 100%;
      z-index: 1000;
    }
    .header h1 {
      font-size: 20px;
      margin: 0;
    }
    .nav-bar {
      background: #fff;
      padding: 10px 8px;
      position: fixed;
      top: 60px;
      width: 100%;
      z-index: 900;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
      display: flex;
      justify-content: space-around;
      flex-wrap: wrap;
      gap: 5px;
    }
    .nav-bar a {
      color: #004d40;
      text-decoration: none;
      font-size: 14px;
      font-weight: 500;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 6px;
      transition: transform 0.3s ease;
      background: #e0e0e0;
      border-radius: 8px;
    }
    .nav-bar a i {
      font-size: 18px;
      margin-bottom: 2px;
    }
    .nav-bar a:hover {
      transform: scale(1.05);
      background: #ffca28;
    }
    .main-content {
      flex: 1;
      padding: 120px 12px 80px;
      overflow-y: auto;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 12px;
    }
    .dashboard-card {
      background: #fff;
      padding: 16px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      border-left: 3px solid #ff7043;
      cursor: pointer;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      height: 180px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }
    .dashboard-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    .dashboard-card h1 {
      font-size: 18px;
      color: #00695c;
      margin-bottom: 10px;
      font-weight: 600;
      border-bottom: 2px solid #ffca28;
      padding-bottom: 6px;
    }
    .dashboard-card p {
      font-size: 13px;
      color: #555;
    }
    .quote {
      grid-column: 1 / -1;
      background: #e6f3f2;
      padding: 12px;
      border-radius: 8px;
      text-align: center;
      font-style: italic;
      color: #00695c;
      border-left: 3px solid #ffca28;
      font-size: 14px;
      margin: 12px 0;
    }
    .section {
      display: none;
      background: #fff;
      padding: 16px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      margin: 12px 0;
      border-left: 3px solid #ff7043;
      animation: fadeIn 0.5s ease-in;
    }
    .section.active {
      display: block;
      grid-column: 1 / -1;
    }
    h2 {
      color: #ff7043;
      font-size: 16px;
      margin-bottom: 10px;
      font-weight: 600;
    }
    .card {
      background: #fff;
      padding: 16px;
      border-radius: 10px;
      margin-bottom: 12px;
      border: 1px solid #e0e0e0;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.03);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 13px;
      overflow-x: auto;
      display: block;
    }
    th, td {
      border: 1px solid #d1d9e0;
      padding: 8px;
      text-align: left;
    }
    th {
      background: #ffca28;
      color: #004d40;
      font-weight: 600;
    }
    tr:nth-child(even) {
      background: #f5f7fa;
    }
    .fees-highlight {
      font-weight: 600;
      color: #004d40;
      background: #fff3e0;
      padding: 6px 12px;
      border-radius: 6px;
      display: inline-block;
    }
    .announcement-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
      margin-top: 12px;
    }
    .announcement-card {
      background: #fff3e0;
      padding: 12px;
      border-radius: 10px;
      border-left: 3px solid #ff7043;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .announcement-card.unread {
      background: #ffe0b2;
      font-weight: 500;
      box-shadow: 0 2px 6px rgba(255, 112, 67, 0.1);
    }
    .announcement-card.read {
      background: #fff3e0;
    }
    .announcement-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
    }
    .announcement-card h4 {
      margin: 0 0 10px;
      color: #00695c;
      font-size: 16px;
    }
    .announcement-card p {
      margin: 6px 0;
      font-size: 13px;
    }
    .announcement-card .mark-read {
      background: #ff7043;
      color: #fff;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
      transition: background 0.3s ease, transform 0.3s ease;
      margin-top: 10px;
    }
    .announcement-card .mark-read:hover {
      background: #f4511e;
      transform: scale(1.05);
    }
    button {
      padding: 10px 20px;
      background: linear-gradient(135deg, #ffca28, #ffd700);
      color: #004d40;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    button:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }
    .error-message {
      color: #d32f2f;
      font-size: 13px;
      margin: 12px;
      padding: 10px;
      background: #ffebee;
      border-radius: 6px;
      text-align: center;
    }
    .payment-center {
      text-align: center;
      padding: 16px;
      background: #fffde7;
      border-radius: 10px;
      border: 1px dashed #ffca28;
      margin-bottom: 12px;
    }
    .payment-center h1 {
      font-size: 18px;
      color: #ff7043;
      margin-bottom: 12px;
    }
    .payment-assurance {
      list-style: none;
      padding: 0;
      margin: 12px 0;
    }
    .payment-assurance li {
      margin: 8px 0;
      font-size: 13px;
      color: #00695c;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .payment-assurance li i {
      color: #4caf50;
      margin-right: 8px;
      font-size: 16px;
    }
    .progress-bar {
      width: 100%;
      background-color: #e0e0e0;
      border-radius: 6px;
      margin: 12px 0;
      overflow: hidden;
    }
    .progress {
      height: 18px;
      border-radius: 6px;
      background: linear-gradient(135deg, #ffca28, #ffd700);
      text-align: center;
      color: #004d40;
      line-height: 18px;
      font-size: 11px;
      font-weight: 500;
    }
    .term-select {
      margin: 12px 0;
      padding: 8px;
      font-size: 13px;
      border-radius: 6px;
      border: 1px solid #d1d9e0;
      width: 100%;
      max-width: 200px;
    }
    .announcements-nav {
      margin-bottom: 12px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .announcements-nav button {
      background: #e0e0e0;
      padding: 6px 12px;
      font-size: 12px;
      border-radius: 6px;
      color: #004d40;
    }
    .announcements-nav button.active {
      background: #ff7043;
      color: #fff;
    }
    .announcements-nav button:hover {
      background: #ffca28;
      transform: scale(1.05);
    }
    .bottom-nav {
      display: none;
      position: fixed;
      bottom: 0;
      width: 100%;
      background: #fff;
      padding: 8px 0;
      box-shadow: 0 -2px 6px rgba(0, 0, 0, 0.05);
      z-index: 1000;
      flex-wrap: wrap;
      gap: 5px;
    }
    .bottom-nav .nav-items {
      display: flex;
      justify-content: space-around;
      align-items: center;
    }
    .bottom-nav a {
      color: #004d40;
      text-decoration: none;
      font-size: 11px;
      font-weight: 500;
      text-align: center;
      padding: 4px;
      background: #e0e0e0;
      border-radius: 6px;
    }
    .bottom-nav a i {
      display: block;
      font-size: 16px;
      margin-bottom: 2px;
    }
    .bottom-nav a:hover {
      transform: scale(1.05);
      background: #ffca28;
    }
    footer {
      background: #004d40;
      color: #fff;
      text-align: center;
      padding: 10px 0;
      font-size: 12px;
      z-index: 999;
    }
    footer p {
      margin: 3px 0;
    }
    footer a {
      color: #ffca28;
      text-decoration: none;
    }
    footer a:hover {
      text-decoration: underline;
    }
    .helb-card {
      background: #e6f3f2;
      padding: 16px;
      border-radius: 10px;
      margin-bottom: 12px;
      border-left: 3px solid #ffca28;
      text-align: center;
    }
    .coming-soon {
      background: #fffde7;
      padding: 16px;
      border-radius: 10px;
      margin-bottom: 12px;
      border: 1px dashed #ffca28;
      text-align: center;
      color: #ff7043;
      font-style: italic;
      font-size: 14px;
    }
    .fees-world {
      background: url('data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 320"%3E%3Cpath fill="%23ffca28" fill-opacity="0.1" d="M0,64L48,80C96,96,192,128,288,128C384,128,480,96,576,85.3C672,75,768,85,864,90.7C960,96,1056,96,1152,85.3C1248,75,1344,53,1392,42.7L1440,32L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z"%3E%3C/path%3E%3C/svg%3E'), #fff;
      background-size: cover;
      padding: 16px;
      border-radius: 10px;
      margin-bottom: 12px;
      border: 1px solid #ffca28;
      text-align: center;
    }
    .fees-world h2 {
      color: #004d40;
      font-size: 16px;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @media (max-width: 768px) {
      .main-content {
        padding: 110px 8px 70px;
        grid-template-columns: 1fr;
      }
      .nav-bar {
        flex-direction: column;
        align-items: center;
        padding: 8px 0;
        gap: 5px;
      }
      .nav-bar a {
        width: 45%;
        text-align: center;
      }
      .header h1 {
        font-size: 18px;
      }
      .dashboard-card {
        height: 150px;
      }
      .dashboard-card h1 {
        font-size: 16px;
      }
      .dashboard-card p {
        font-size: 12px;
      }
      .bottom-nav {
        display: flex;
      }
      .bottom-nav a {
        width: 45%;
      }
    }
    @media (min-width: 769px) {
      .bottom-nav {
        display: none;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Borabu TTC Student Portal</h1>
    </div>
    <div class="nav-bar">
      <a href="#" onclick="showSection('profile')"><i class="fas fa-user"></i> Profile</a>
      <a href="#" onclick="showSection('marks')"><i class="fas fa-book"></i> Academics</a>
      <a href="#" onclick="showSection('fees')"><i class="fas fa-money-bill"></i> Fees</a>
      <a href="#" onclick="showSection('payFees')"><i class="fas fa-credit-card"></i> Pay Fees</a>
      <a href="#" onclick="showSection('announcements')"><i class="fas fa-bullhorn"></i> Announcements</a>
      <a href="#" onclick="showSection('timetables')"><i class="fas fa-calendar"></i> Timetables</a>
      <a href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</a>
    </div>
    <div class="main-content">
      <div class="quote">
        <h2>Daily Quote</h2>
        <p id="dailyQuote">"Education is the key to unlocking the world, a passport to freedom." - Finley Onchiri</p>
      </div>
      <div class="dashboard-card" onclick="showSection('profile')">
        <h1>Profile</h1>
        <p>View your personal details and HELB options.</p>
      </div>
      <div class="dashboard-card" onclick="showSection('marks')">
        <h1>Academics</h1>
        <p>Check your marks and download reports.</p>
      </div>
      <div class="dashboard-card" onclick="showSection('fees')">
        <h1>Fees</h1>
        <p>Monitor your fee status and transactions.</p>
      </div>
      <div class="dashboard-card" onclick="showSection('payFees')">
        <h1>Pay Fees</h1>
        <p>Make secure payments online.</p>
      </div>
      <div class="dashboard-card" onclick="showSection('announcements')">
        <h1>Announcements</h1>
        <p>Stay updated with the latest news.</p>
      </div>
      <div class="dashboard-card" onclick="showSection('timetables')">
        <h1>Timetables</h1>
        <p>Coming soon—your schedule awaits!</p>
      </div>
      <div id="profile" class="section active">
        <h1>Profile</h1>
        <div class="card profile-info">
          <p><i class="fas fa-id-card"></i> Admission Number: <strong id="regNo"></strong></p>
          <p><i class="fas fa-user"></i> Name: <strong id="name">N/A</strong></p>
          <p><i class="fas fa-calendar"></i> Year: <strong id="year">N/A</strong></p>
          <p><i class="fas fa-stream"></i> Stream: <strong id="stream">N/A</strong></p>
          <p><i class="fas fa-venus-mars"></i> Gender: <strong id="gender">N/A</strong></p>
          <p><i class="fas fa-users"></i> Parent Name: <strong id="parentName">N/A</strong></p>
          <p><i class="fas fa-phone"></i> Parent Phone: <strong id="parentPhone">N/A</strong></p>
          <div class="progress-bar">
            <div class="progress" id="progressBar" style="width: 0%;">0% Graduation Tracker</div>
          </div>
        </div>
        <div class="helb-card">
          <h2>Apply for HELB Now!</h2>
          <p><i class="fas fa-graduation-cap"></i> Secure financial support for your education through the Higher Education Loans Board (HELB).</p>
          <button onclick="window.open('https://www.helb.co.ke/', '_blank')"><i class="fas fa-external-link-alt"></i> Apply</button>
        </div>
        <p><strong>Explanation:</strong> View your personal details, including admission number, name, year, stream, gender, and parent contact information. The HELB section provides loans to cover tuition and living expenses, repayable after graduation with flexible terms.</p>
      </div>
      <div id="marks" class="section">
        <h1>Academics</h1>
        <select class="term-select" id="termSelect" onchange="updateMarks()">
          <option value="term1">Term 1</option>
          <option value="term2">Term 2</option>
          <option value="term3">Term 3</option>
        </select>
        <div class="card">
          <table id="marksTable">
            <thead>
              <tr>
                <th>Term</th>
                <th>Subject</th>
                <th>CAT Score</th>
                <th>Exam Score</th>
                <th>Grade</th>
              </tr>
            </thead>
            <tbody id="marksBody"></tbody>
          </table>
        </div>
        <button onclick="downloadPDF()"><i class="fas fa-file-pdf"></i> Download PDF</button>
        <p><strong>Explanation:</strong> Check your academic performance with CAT and exam scores across terms and subjects, with downloadable PDFs for tracking.</p>
      </div>
      <div id="fees" class="section">
        <h1>Fees</h1>
        <div class="fees-world">
          <h2>Your Fees World</h2>
          <p>Total: <span class="fees-highlight" id="feesTotal">N/A</span></p>
          <p>Paid: <span class="fees-highlight" id="feesPaid">N/A</span></p>
          <p>Balance: <span class="fees-highlight" id="feesBalance">N/A</span></p>
          <p>Statement: <span id="feesStatement">N/A</span></p>
          <table id="transactionsTable">
            <thead>
              <tr>
                <th>Date</th>
                <th>Amount</th>
                <th>Method</th>
                <th>Payer</th>
                <th>Transaction Code</th>
              </tr>
            </thead>
            <tbody id="transactionsBody"></tbody>
          </table>
          <button onclick="downloadFeePDF()"><i class="fas fa-file-pdf"></i> Download Fee PDF</button>
        </div>
        <p><strong>Explanation:</strong> Monitor your fee status, including total, paid, balance, and transaction history, with a downloadable PDF.</p>
      </div>
      <div id="payFees" class="section">
        <h1>Pay Fees</h1>
        <div class="payment-center">
          <h1>Welcome to Borabu TTC Fee Payment Centre</h1>
          <p>Make your payments with ease and confidence!</p>
          <ul class="payment-assurance">
            <li><i class="fas fa-clock"></i> Fast Processing</li>
            <li><i class="fas fa-tools"></i> Reliable Service</li>
            <li><i class="fas fa-shield-alt"></i> Trusted Platform</li>
            <li><i class="fas fa-lock"></i> Secure Transactions</li>
            <li><i class="fas fa-headset"></i> 24/7 Support</li>
          </ul>
          <button onclick="window.open('https://payment.intasend.com/pay/b90e1c19-33da-4b7d-a654-c4fb72eb9ea7/', '_blank')"><i class="fas fa-credit-card"></i> Pay Now</button>
          <p>After payment, contact the Accounts Office to confirm receipt. Visit for assistance if needed.</p>
        </div>
        <p><strong>Explanation:</strong> Access a secure payment portal with support for any issues.</p>
      </div>
      <div id="announcements" class="section">
        <h1>Announcements</h1>
        <div class="announcements-nav">
          <button id="generalBtn" class="active" onclick="showAnnouncements('general')">General</button>
          <button id="individualBtn" onclick="showAnnouncements('individual')">Individual</button>
        </div>
        <div class="card">
          <div class="announcement-grid" id="announcementsContainer"></div>
        </div>
        <p><strong>Explanation:</strong> Stay updated with the latest news and messages.</p>
      </div>
      <div id="timetables" class="section">
        <h1>Timetables</h1>
        <div class="coming-soon">
          <p><i class="fas fa-clock"></i> Coming Soon! Get ready for your schedule updates!</p>
        </div>
        <p><strong>Explanation:</strong> A new section for timetables is coming soon.</p>
      </div>
    </div>
    <div class="bottom-nav">
      <div class="nav-items">
        <a href="#" onclick="showSection('profile')"><i class="fas fa-user"></i> Profile</a>
        <a href="#" onclick="showSection('marks')"><i class="fas fa-book"></i> Academics</a>
        <a href="#" onclick="showSection('fees')"><i class="fas fa-money-bill"></i> Fees</a>
        <a href="#" onclick="showSection('payFees')"><i class="fas fa-credit-card"></i> Pay</a>
        <a href="#" onclick="showSection('announcements')"><i class="fas fa-bullhorn"></i> News</a>
        <a href="#" onclick="showSection('timetables')"><i class="fas fa-calendar"></i> Timetables</a>
        <a href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</a>
      </div>
    </div>
  </div>
  <div id="errorMessage" class="error-message"></div>
  <footer>
    <p>Contact: <a href="mailto:info@borabuttc.ac.ke">info@borabuttc.ac.ke</a> | Phone: +254 712 345 678</p>
    <p>© 2025 Borabu Teachers Training College. All rights reserved.</p>
  </footer>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCi9NWfDwbWSByd_R7ueNkLcQsFlBJ5_VA",
      authDomain: "web-reg-cbf2f.firebaseapp.com",
      databaseURL: "https://web-reg-cbf2f-default-rtdb.firebaseio.com",
      projectId: "web-reg-cbf2f",
      storageBucket: "web-reg-cbf2f.firebasestorage.app",
      messagingSenderId: "431303341740",
      appId: "1:431303341740:web:542070e4c471cd7c8ad109",
      measurementId: "G-164GMVZQY3"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    function showSection(section) {
      document.querySelectorAll(".section").forEach(div => div.classList.remove("active"));
      document.getElementById(section).classList.add("active");
    }

    function showError(message) {
      const errorDiv = document.getElementById("errorMessage");
      errorDiv.textContent = message;
      errorDiv.style.display = "block";
      setTimeout(() => { errorDiv.style.display = "none"; }, 5000);
      console.error(message);
    }

    function getUserNameByEmail(email, role) {
      return db.ref(`users/${role}`).once("value").then(snapshot => {
        const users = snapshot.val() || {};
        for (let key in users) {
          if (users[key].email === email || users[key].email === email + ".stacc@moke.ac") {
            return users[key].name || email;
          }
        }
        return email.replace(".stacc@moke.ac", "");
      }).catch(() => email.replace(".stacc@moke.ac", ""));
    }

    function logout() {
      localStorage.clear();
      console.log("Logged out, redirecting to index.html");
      setTimeout(() => window.location.href = "index.html", 100);
    }

    function updateMarks() {
      const term = document.getElementById("termSelect").value;
      const regNo = localStorage.getItem("regNo")?.replace(/\//g, "_");
      if (!regNo) {
        showError("No registration number found in localStorage.");
        return;
      }
      const studentRef = db.ref("users/students/" + regNo);
      studentRef.once("value", (snapshot) => {
        if (snapshot.exists()) {
          const data = snapshot.val();
          const marksBody = document.getElementById("marksBody");
          marksBody.innerHTML = "";
          const termData = data.marks?.[term] || data.academics?.[term];
          let hasMarks = false;
          if (termData) {
            hasMarks = true;
            for (const [subject, catScore] of Object.entries(termData.cat || {})) {
              const examScore = termData.exam?.[subject] || (termData[subject] || "-");
              const grade = termData.grades?.[subject] || termData.grades?.[subject.toLowerCase()] || "-";
              marksBody.innerHTML += `<tr>
                <td>${term.replace("term", "Term ")}</td>
                <td>${subject}</td>
                <td>${catScore !== undefined ? catScore : "-"}</td>
                <td>${examScore !== undefined ? examScore : "-"}</td>
                <td>${grade}</td>
              </tr>`;
            }
          }
          if (!hasMarks) {
            marksBody.innerHTML = "<tr><td colspan='5'>No marks available for this term</td></tr>";
          }
        } else {
          showError("Student data not found for regNo: " + regNo);
        }
      }).catch((error) => {
        showError("Failed to update marks: " + error.message);
      });
    }

    function downloadPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const name = document.getElementById("name").textContent;
      const regNo = document.getElementById("regNo").textContent;
      const stream = document.getElementById("stream").textContent;
      const year = document.getElementById("year").textContent;
      const today = new Date().toLocaleDateString();
      const marksBody = document.getElementById("marksBody");

      doc.setFontSize(16);
      doc.setFillColor(255, 215, 0);
      doc.rect(0, 0, 210, 30, "F");
      doc.setTextColor(0, 77, 64);
      doc.text("Borabu Teacher's Training College", 70, 20);
      doc.setFontSize(10);
      doc.setTextColor(0, 0, 0);
      doc.text("P.O. Box 443, Nyamira", 85, 26);
      doc.text("Date: " + today, 150, 26);

      doc.setFontSize(12);
      doc.text("Name: " + name, 20, 40);
      doc.text("Reg No: " + regNo, 20, 48);
      doc.text("Stream: " + stream, 20, 56);
      doc.text("Year: " + year, 20, 64);
      doc.text("Course: Diploma in Primary Education", 20, 72);

      const rows = [];
      if (marksBody.querySelectorAll("tr").length > 0) {
        marksBody.querySelectorAll("tr").forEach(row => {
          const cols = Array.from(row.querySelectorAll("td")).map(td => td.textContent);
          rows.push(cols);
        });
        doc.autoTable({
          startY: 82,
          head: [["Term", "Subject", "CAT Score", "Exam Score", "Grade"]],
          body: rows,
          theme: 'grid',
          styles: { cellPadding: 3, fontSize: 10, lineColor: [0, 0, 0], lineWidth: 0.1 },
          headStyles: { fillColor: [255, 202, 40], textColor: [0, 77, 64], fontStyle: 'bold' },
          bodyStyles: { alternateRowStyles: { fillColor: [245, 247, 250] } },
        });
      } else {
        doc.text("No marks available for this term", 20, 82);
      }

      doc.setFontSize(10);
      doc.text("Lecturer: Mr. Mojo", 20, 280);
      doc.text("Assistant: Mrs. Mojo", 120, 280);

      doc.save(`${name.replace(/ /g, "_")}_Report.pdf`);
    }

    function downloadFeePDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const name = document.getElementById("name").textContent;
      const regNo = document.getElementById("regNo").textContent;
      const today = new Date().toLocaleDateString();
      const total = document.getElementById("feesTotal").textContent.replace(/,/g, "");
      const paid = document.getElementById("feesPaid").textContent.replace(/,/g, "");
      const balance = document.getElementById("feesBalance").textContent.replace(/,/g, "");
      const statement = document.getElementById("feesStatement").textContent;
      const transactionsBody = document.getElementById("transactionsBody");

      doc.setFontSize(16);
      doc.setFillColor(255, 215, 0);
      doc.rect(0, 0, 210, 30, "F");
      doc.setTextColor(0, 77, 64);
      doc.text("Borabu Teacher's Training College", 70, 20);
      doc.setFontSize(10);
      doc.setTextColor(0, 0, 0);
      doc.text("P.O. Box 443, Nyamira", 85, 26);
      doc.text("Date: " + today, 150, 26);

      doc.setFontSize(12);
      doc.text("Name: " + name, 20, 40);
      doc.text("Reg No: " + regNo, 20, 48);
      doc.text("Total Fees: KES " + total, 20, 56);
      doc.text("Paid: KES " + paid, 20, 64);
      doc.text("Balance: KES " + balance, 20, 72);
      doc.text("Statement: " + statement, 20, 80);

      const rows = [];
      if (transactionsBody.querySelectorAll("tr").length > 0) {
        transactionsBody.querySelectorAll("tr").forEach(row => {
          const cols = Array.from(row.querySelectorAll("td")).map(td => td.textContent);
          rows.push(cols);
        });
        doc.autoTable({
          startY: 90,
          head: [["Date", "Amount", "Method", "Payer", "Transaction Code"]],
          body: rows,
          theme: 'grid',
          styles: { cellPadding: 3, fontSize: 10, lineColor: [0, 0, 0], lineWidth: 0.1 },
          headStyles: { fillColor: [255, 202, 40], textColor: [0, 77, 64], fontStyle: 'bold' },
          bodyStyles: { alternateRowStyles: { fillColor: [245, 247, 250] } },
        });
      } else {
        doc.text("No transactions available", 20, 90);
      }

      doc.setFontSize(10);
      doc.text("Accounts Office", 20, 280);
      doc.text("Contact: +254 712 345 678", 120, 280);

      doc.save(`${name.replace(/ /g, "_")}_Fee_Report.pdf`);
    }

    window.onload = function() {
      const userType = localStorage.getItem("userType");
      const regNo = localStorage.getItem("regNo");
      const studentName = localStorage.getItem("studentName");
      console.log("Student.html loaded, localStorage:", { userType, regNo, studentName });

      if (!userType || userType !== "student" || !regNo) {
        showError("Invalid session or missing registration number. Redirecting...");
        localStorage.clear();
        setTimeout(() => window.location.href = "index.html", 100);
        return;
      }

      document.getElementById("regNo").textContent = regNo.replace(/_/g, "/");

      const studentRef = db.ref("users/students/" + regNo.replace(/\//g, "_"));
      studentRef.once("value", (snapshot) => {
        if (snapshot.exists()) {
          const data = snapshot.val();
          const profile = data.profile || {};
          document.getElementById("name").textContent = profile.name || data.name || "N/A";
          const year = profile.year || data.form?.replace("form", "Year ") || "N/A";
          document.getElementById("year").textContent = year;
          const progress = year === "Year 1" ? 25 : year === "Year 2" ? 50 : year === "Year 3" ? 75 : year === "Year 4" ? 100 : 0;
          document.getElementById("progressBar").style.width = progress + "%";
          document.getElementById("progressBar").textContent = progress + "% Graduation Tracker";
          document.getElementById("stream").textContent = profile.stream || data.stream || "N/A";
          document.getElementById("gender").textContent = profile.gender || data.gender || "N/A";
          document.getElementById("parentName").textContent = profile.parentName || data.parentName || "N/A";
          document.getElementById("parentPhone").textContent = profile.parentPhone || data.parentPhone || "N/A";

          const marksBody = document.getElementById("marksBody");
          marksBody.innerHTML = "";
          const term = document.getElementById("termSelect").value;
          const termData = data.marks?.[term] || data.academics?.[term];
          if (termData) {
            for (const [subject, catScore] of Object.entries(termData.cat || {})) {
              const examScore = termData.exam?.[subject] || (termData[subject] || "-");
              const grade = termData.grades?.[subject] || termData.grades?.[subject.toLowerCase()] || "-";
              marksBody.innerHTML += `<tr>
                <td>${term.replace("term", "Term ")}</td>
                <td>${subject}</td>
                <td>${catScore !== undefined ? catScore : "-"}</td>
                <td>${examScore !== undefined ? examScore : "-"}</td>
                <td>${grade}</td>
              </tr>`;
            }
          } else {
            marksBody.innerHTML = "<tr><td colspan='5'>No marks available for this term</td></tr>";
          }

          const feesData = data.fees || {};
          const total = feesData.total || feesData.totalExpected || 0;
          const paidFromDb = feesData.paid || 0;
          const transactions = feesData.transactions || [];
          let totalPaid = paidFromDb;
          if (Array.isArray(transactions)) {
            totalPaid += transactions.reduce((sum, tx) => sum + (tx.amount || 0), 0);
          } else if (typeof transactions === "object") {
            totalPaid += Object.values(transactions).reduce((sum, tx) => sum + (tx.amount || 0), 0);
          }
          const balanceFromDb = feesData.balance !== undefined ? feesData.balance : null;
          const calculatedBalance = Math.max(0, total - totalPaid);
          const balance = balanceFromDb !== null ? balanceFromDb : calculatedBalance;
          const statement = feesData.statement || "N/A";
          document.getElementById("feesTotal").textContent = total.toLocaleString() || "N/A";
          document.getElementById("feesPaid").textContent = totalPaid.toLocaleString() || "N/A";
          document.getElementById("feesBalance").textContent = balance.toLocaleString() || "N/A";
          document.getElementById("feesStatement").textContent = statement;

          const transactionsBody = document.getElementById("transactionsBody");
          transactionsBody.innerHTML = "";
          if (Array.isArray(transactions)) {
            transactions.forEach(tx => {
              transactionsBody.innerHTML += `<tr>
                <td>${tx.date || "-"}</td>
                <td>${tx.amount || "0"}</td>
                <td>${tx.method || "-"}</td>
                <td>${tx.payer || "-"}</td>
                <td>${tx.transactionCode || tx.mpesaCode || "-"}</td>
              </tr>`;
            });
          } else if (typeof transactions === "object") {
            Object.values(transactions).forEach(tx => {
              transactionsBody.innerHTML += `<tr>
                <td>${tx.date || "-"}</td>
                <td>${tx.amount || "0"}</td>
                <td>${tx.method || "-"}</td>
                <td>${tx.payer || "-"}</td>
                <td>${tx.transactionCode || tx.mpesaCode || "-"}</td>
              </tr>`;
            });
          }
        } else {
          showError("Student data not found for regNo: " + regNo);
          localStorage.clear();
          setTimeout(() => window.location.href = "index.html", 100);
        }
      }).catch((error) => {
        showError("Failed to load data: " + error.message);
        console.log("Error loading student data:", error);
        localStorage.clear();
        setTimeout(() => window.location.href = "index.html", 100);
      });

      const normalizedRegNo = regNo.replace(/\//g, "_");
      const announcementsRef = db.ref("announcements");
      const announcementsContainer = document.getElementById("announcementsContainer");

      function updateAnnouncements(type) {
        announcementsContainer.innerHTML = "<p><i class='fas fa-spinner fa-spin'></i> Loading announcements...</p>";
        const isIndividual = type === "individual";
        const snapRef = isIndividual ? announcementsRef.child("individual").child(normalizedRegNo) : announcementsRef.child("general");
        snapRef.once("value", (snapshot) => {
          const announcements = [];
          const readRef = db.ref(`users/students/${normalizedRegNo}/readAnnouncements`);
          readRef.once("value", (readSnapshot) => {
            const readAnnouncements = readSnapshot.val() || {};
            snapshot.forEach(childSnapshot => {
              const value = childSnapshot.val();
              if (value && (value.message || value.text)) {
                const sender = value.sender || value.teacher || value.accountant || (isIndividual ? "Unknown" : value.author);
                const isRead = readAnnouncements[childSnapshot.key] === true;
                announcements.push({
                  ...value,
                  key: childSnapshot.key,
                  type,
                  sender: sender || "Unknown",
                  date: value.date || new Date().toISOString(),
                  isRead
                });
              }
            });
            if (announcements.length === 0) {
              announcementsContainer.innerHTML = `<p>No ${isIndividual ? "individual" : "general"} announcements available.</p>`;
            } else {
              Promise.all(announcements.map(ann => {
                if (ann.sender && ann.sender !== "Unknown") {
                  return getUserNameByEmail(ann.sender + (ann.sender.includes("@") ? "" : ".stacc@moke.ac"), ann.role === "accountant" ? "accountants" : "teachers")
                    .then(name => ({ ...ann, sender: name }));
                }
                return Promise.resolve(ann);
              })).then(updatedAnnouncements => {
                renderAnnouncements(updatedAnnouncements);
              });
            }
          });
        }, (error) => {
          showError("Failed to load announcements: " + error.message);
          console.log("Error loading announcements:", error);
        });
      }

      function renderAnnouncements(announcements) {
        announcementsContainer.innerHTML = "";
        announcements.sort((a, b) => new Date(b.date) - new Date(a.date));
        announcements.forEach(ann => {
          const div = document.createElement("div");
          div.className = `announcement-card ${ann.isRead ? "read" : "unread"}`;
          div.innerHTML = `
            <h4>${ann.title || ann.text || ann.message} (${new Date(ann.date).toLocaleDateString()})</h4>
            <p>${ann.message || ann.text}</p>
            <p><strong>By:</strong> ${ann.sender || "Unknown"}</p>
            ${ann.type === "individual" ? '<p><strong>To:</strong> You</p>' : ""}
            ${ann.isRead ? '' : `<button class="mark-read" onclick="markAsRead('${ann.key}', '${ann.type}')">Mark as Read</button>`}
          `;
          announcementsContainer.appendChild(div);
        });
      }

      function markAsRead(key, type) {
        const regNo = localStorage.getItem("regNo").replace(/\//g, "_");
        const readRef = db.ref(`users/students/${regNo}/readAnnouncements/${key}`);
        readRef.set(true).then(() => {
          showError("Announcement marked as read!", false);
          updateAnnouncements(type);
        }).catch(error => {
          showError("Failed to mark announcement as read: " + error.message);
        });
      }

      updateAnnouncements("general");
      window.showAnnouncements = function(type) {
        const generalBtn = document.getElementById("generalBtn");
        const individualBtn = document.getElementById("individualBtn");
        if (type === "general") {
          generalBtn.classList.add("active");
          individualBtn.classList.remove("active");
        } else {
          generalBtn.classList.remove("active");
          individualBtn.classList.add("active");
        }
        updateAnnouncements(type);
      };
    };
  </script>
</body>
</html>